name: Gemini ë¬¸ì œ í’€ì´ ì½”ë“œ ë¦¬ë·°

on:
  push:
    paths:
      - '**/ë°±ì¤€/**.py'
      - '**/swea/**.py'
      - '**/í”„ë¡œê·¸ë˜ë¨¸ìŠ¤/**.py'

permissions:
  contents: write

jobs:
  review:
    runs-on: ubuntu-latest
    environment: GEMINI_API_KEY

    steps:
      - name: ğŸ“¦ ì €ì¥ì†Œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v3
        with:
          fetch-depth: 1

      - name: ğŸ”¢ ìµœê·¼ íŒŒì¼ í™•ì¸
        run: |
          echo "ğŸ” ìœ íš¨í•œ ë””ë ‰í† ë¦¬ì—ì„œ ìµœì‹  Python íŒŒì¼ ì°¾ëŠ” ì¤‘..."

          SEARCH_DIRS=""
          for d in ë°±ì¤€ swea í”„ë¡œê·¸ë˜ë¨¸ìŠ¤; do
            if [ -d "$d" ]; then
              SEARCH_DIRS="$SEARCH_DIRS $d"
            fi
          done

          if [ -z "$SEARCH_DIRS" ]; then
            echo "âŒ ê²€ìƒ‰í•  ë””ë ‰í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤. ì¢…ë£Œí•©ë‹ˆë‹¤."
            exit 0
          fi

          FILE=$(find $SEARCH_DIRS -name "*.py" -type f -printf "%T@ %p\n" | sort -n | tail -1 | cut -d' ' -f2-)
          echo "âœ… ìµœì‹  Python íŒŒì¼: $FILE"

          echo "FILE_PATH=$FILE" >> $GITHUB_ENV

      - name: ğŸ¤– Geminiì—ì„œ íŒŒì¼ ë¶„ì„ & ë¦¬í¬íŠ¸ ì €ì¥
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          FILE_PATH: ${{ env.FILE_PATH }}
        run: |
          set -e

          if [ -z "$FILE_PATH" ]; then
            echo "âŒ ì²˜ë¦¬í•  íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤."
            exit 0
          fi

          CONTENT=$(cat "$FILE_PATH")
          if [ -z "$CONTENT" ]; then
            echo "âŒ íŒŒì¼ ë‚´ìš©ì´ ë¹„ì–´ ìˆìŒ â†’ ì¢…ë£Œ"
            exit 0
          fi

          FILENAME=$(basename "$FILE_PATH")
          PLATFORM=$(basename $(dirname "$FILE_PATH"))
          PROBLEM_ID="${FILENAME%.py}"

          PROMPT="ë¬¸ì œ: $PLATFORM ${PROBLEM_ID}ë²ˆ\n\n"
          PROMPT+=$(cat <<'EOF'
          ë‹¤ìŒì€ Python ì•Œê³ ë¦¬ì¦˜ ì½”ë“œì…ë‹ˆë‹¤.
          
          ì´ ì½”ë“œë¥¼ ì ˆëŒ€ ìˆ˜ì •í•˜ì§€ ë§ê³ , ì•„ë˜ ê¸°ì¤€ì— ë”°ë¼ **40ì  ë§Œì **ìœ¼ë¡œ ì •ë°€í•˜ê²Œ í‰ê°€í•´ì£¼ì„¸ìš”:
          
          1. ì•Œê³ ë¦¬ì¦˜ ì„ íƒ ì í•©ì„± (20ì )
             - ë¬¸ì œ ìœ í˜•ì— ë§ëŠ” ì•Œê³ ë¦¬ì¦˜ì„ ì„ íƒí–ˆëŠ”ê°€? (1ì ì”© 5í•­ëª©)
               - ë¬¸ì œ ì¡°ê±´ê³¼ ë§ëŠ” íƒìƒ‰/ì •ë ¬/DP ë“±ì¸ì§€?
               - ê³¼í•œ ì•Œê³ ë¦¬ì¦˜ì„ ì‚¬ìš©í•˜ì§€ ì•Šì•˜ëŠ”ê°€?
               - ì§ê´€ì ì¸ êµ¬ì¡°ë¥¼ ê°–ì·„ëŠ”ê°€?
               - ë¶ˆí•„ìš”í•œ ë¡œì§ì´ ì—†ëŠ”ê°€?
               - ìë£Œêµ¬ì¡° ì„ íƒì´ ì ì ˆí–ˆëŠ”ê°€?
          
          2. ì‹œê°„ë³µì¡ë„ ìµœì í™” ì—¬ë¶€ (20ì )
             - ì‹œê°„ë³µì¡ë„ ê°œì„ ì´ ê³ ë ¤ë˜ì—ˆëŠ”ê°€? (1ì ì”© 5í•­ëª©)
               - ë¶ˆí•„ìš”í•œ ë°˜ë³µ/ì¤‘ë³µ ê³„ì‚° ì œê±°?
               - ì…ì¶œë ¥ ë³‘ëª© ì²˜ë¦¬?
               - ì •ë ¬/íƒìƒ‰ ìµœì í™” ì—¬ë¶€?
               - ìµœì•… ì¼€ì´ìŠ¤ ëŒ€ì‘ êµ¬ì¡°?
               - ì´ë¡ ì  ì‹œê°„ë³µì¡ë„ ë¶„ì„ ê°€ëŠ¥?
          
          ---
          
          **í•„ìˆ˜ í¬í•¨ í•­ëª©**:
          
          - ì…ë ¥ ì¼€ì´ìŠ¤ Nì˜ ë²”ìœ„ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì˜ˆìƒ ì‹œê°„ë³µì¡ë„ O(...) ë¶„ì„
          - ìµœëŒ€ ì…ë ¥ ê¸°ì¤€ ì˜ˆìƒ ì‹¤í–‰ ì‹œê°„ (ex: ì•½ 0.25ì´ˆ)
          - ìµœëŒ€ ì…ë ¥ ê¸°ì¤€ ì˜ˆìƒ ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ (ex: 40MB)
          - í˜„ êµ¬ì¡°ë¡œ ì–´ë””ê¹Œì§€ ê°œì„  ê°€ëŠ¥í•œì§€ ì¶”ì • (ë‹¨, ê°œì„  ì½”ë“œ ì œì•ˆì€ ê¸ˆì§€)
          
          **ì œì•½**:
          - ì½”ë“œ ìˆ˜ì • ë° ê°œì„  ì½”ë“œ ì œì•ˆ ê¸ˆì§€
          - ë§ˆí¬ë‹¤ìš´ í˜•ì‹ìœ¼ë¡œ ì¶œë ¥
          - ê° í•­ëª©ë§ˆë‹¤ ì ìˆ˜ì™€ ì„¤ëª… ì‘ì„± (1ì  ë‹¨ìœ„)
          - ë§ˆì§€ë§‰ì— ì´ì  ë° ì´í‰ í¬í•¨
          
          ---
          
          Python ì½”ë“œ:
          EOF
          )

          PROMPT="$PROMPT\n$CONTENT"

          JSON_PAYLOAD=$(jq -n --arg content "$PROMPT" '{
            contents: [
              {
                role: "user",
                parts: [{ text: $content }]
              }
            ]
          }')

          RESPONSE=$(curl -s \
            -X POST "https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}" \
            -H "Content-Type: application/json" \
            -d "$JSON_PAYLOAD")

          REVIEW=$(echo "$RESPONSE" | jq -r '.candidates[0].content.parts[0].text // empty')

          if [ -z "$REVIEW" ]; then
            echo "âŒ Gemini ì‘ë‹µ ì—†ìŒ â†’ ì¢…ë£Œ"
            exit 0
          fi

          DIR=$(dirname "$FILE_PATH")
          REPORT_DIR="$DIR/AI report"
          mkdir -p "$REPORT_DIR"

          TIMESTAMP=$(date "+%Y%m%d-%H%M%S")
          REVIEW_FILE="$REPORT_DIR/${{ github.actor }}-$TIMESTAMP.md"

          echo "$REVIEW" > "$REVIEW_FILE"
          echo "âœ… ë¦¬ë·° ì €ì¥ ì™„ë£Œ: $REVIEW_FILE"

      - name: âœ… ë¦¬ë·° ê²°ê³¼ ì»¤ë°‹ & í‘¸ì‹œ
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          FILE=$(find . -name "${{ github.actor }}-*.md" | tail -n 1)
          git add "$FILE"
          git commit -m "ğŸ’¬ Gemini ë¦¬ë·° ìë™ ìƒì„±: $FILE" || echo "âš ï¸ ì»¤ë°‹í•  ë³€ê²½ ì‚¬í•­ ì—†ìŒ"
          git push || echo "âŒ push ì‹¤íŒ¨"